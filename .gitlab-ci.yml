image: docker:stable

services:
  - docker:dind

stages:
  - build
  - deploy

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2

build:
  stage: build
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - cp back/.env back/.env.local
    - cp front/src/environment.js.dist front/src/environment.js
    - sed -i s/%%MEMO_BACK_URL%%/"$MEMO_BACK_URL"/g front/src/environment.js
    - sed -i s/%%MEMO_FRONT_URL%%/"$MEMO_FRONT_URL"/g ci/deploy/dockerfiles/nginx/symfony.conf
    - sed -i s/%%MEMO_BACK_URL%%/"$MEMO_BACK_URL"/g ci/deploy/dockerfiles/nginx/symfony.conf
    - sed -i s/%%MEMO_FRONT_URL%%/"$MEMO_FRONT_URL"/g back/.env.local
    - sed -i s/%%MEMO_DB_USER%%/"$MEMO_DB_USER"/g back/.env.local
    - sed -i s/%%MEMO_DB_PASSWORD%%/"$MEMO_DB_PASSWORD"/g back/.env.local
    - sed -i s/%%MEMO_DB_HOST%%/"$MEMO_DB_HOST"/g back/.env.local
    - sed -i s/%%MEMO_DB_DB%%/"$MEMO_DB_DB"/g back/.env.local
    - mv front ci/deploy/dockerfiles/nginx/front
    - mv back ci/deploy/dockerfiles/nginx/back
    - docker build  -t registry.gitlab.com/kadmelia/memo-clock/nginx:latest ci/deploy/dockerfiles/nginx
    - docker push registry.gitlab.com/kadmelia/memo-clock/nginx:latest
    - mv ci/deploy/dockerfiles/nginx/back ci/deploy/dockerfiles/php/back
    - docker build  -t registry.gitlab.com/kadmelia/memo-clock/php:latest ci/deploy/dockerfiles/php
    - docker push registry.gitlab.com/kadmelia/memo-clock/php:latest

deploy:
  stage: deploy
  image: ubuntu
  script:
    - 'which ssh-agent || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - > /dev/null
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan "$MEMO_BACK_URL" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - '[[ -f /.dockerenv ]] && echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - scp ci/deploy/docker-compose.yml "$MEMO_SSH_USER"@"$MEMO_BACK_URL":$MEMO_SSH_DIR/docker-compose.yml
    - ssh "$MEMO_SSH_USER"@"$MEMO_BACK_URL" "cd $MEMO_SSH_DIR && docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY && docker-compose pull && docker-compose up -d "